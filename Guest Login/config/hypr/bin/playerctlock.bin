#!/bin/bash

if [ $# -eq 0 ]; then
    echo "Usage: $0 --title | --arturl | --artist | --length | --album | --source"
    exit 1
fi

# Function to get metadata using playerctl
get_metadata() {
    key=$1
    playerctl metadata --format "{{ $key }}" 2>/dev/null
}

# Function to determine the source and return an icon and text
get_source_info() {
    trackid=$(get_metadata "mpris:trackid")
    if [[ "$trackid" == *"firefox"* ]]; then
        echo -e "󰈹  Firefox"
    elif [[ "$trackid" == *"spotify"* ]]; then
        echo -e "  Spotify"
    elif [[ "$trackid" == *"chromium"* ]]; then
        echo -e "  Chrome"
    else
        echo ""
    fi
}

# Parse the argument
case "$1" in
    --title)
        title=$(get_metadata "xesam:title")
        if [ -z "$title" ]; then
            echo ""
        else
            echo "${title:0:20}" # Limit to 28 chars
        fi
        ;;
    --arturl)
        url=$(get_metadata "mpris:artUrl")
        if [ -z "$url" ]; then
            echo ""
        else
            if [[ "$url" == file://* ]]; then
                echo "${url#file://}"
            elif [[ "$url" == http* ]]; then
                # Handle remote URLs (Spotify Web/Firefox) by downloading to /tmp
                # Only download if the file doesn't exist or is older than a few seconds to avoid spamming
                tmp_cover="/tmp/hyprlock_cover_art.png"
                if [ ! -f "$tmp_cover" ] || [ "$(find "$tmp_cover" -mmin +1)" ]; then
                     # Check if we actually have a new URL to fetch (simple check)
                     curl -s -o "$tmp_cover" "$url"
                fi
                echo "$tmp_cover"
            else
                echo ""
            fi
        fi
        ;;
    --artist)
        artist=$(get_metadata "xesam:artist")
        if [ -z "$artist" ]; then
            echo ""
        else
            echo "${artist:0:20}" # Limit to 30 chars
        fi
        ;;
    --length)
        length=$(get_metadata "mpris:length")
        if [ -z "$length" ]; then
            echo ""
        else
            # Convert microseconds to m:ss
            seconds=$((length / 1000000))
            echo "$(date -d@$seconds -u +%M:%S)"
        fi
        ;;
    --status)
        status=$(playerctl status 2>/dev/null)
        if [[ $status == "Playing" ]]; then
            echo "󰎆  ...playing"
        elif [[ $status == "Paused" ]]; then
            echo "󱑽  ...paused"
        else
            echo ""
        fi
        ;;
    --album)
        album=$(get_metadata "xesam:album")
        if [[ -n $album ]]; then
            echo "${album:0:20}"
        else
            echo ""
        fi
        ;;
    --source)
        get_source_info
        ;;
    *)
        echo "Invalid option: $1"
        exit 1
        ;;
esac
